
version: 2.1
orbs:
  docker-publish: circleci/docker-publish@0.1.7
jobs:
  unit-test:
    docker:
      - image: circleci/golang:stretch
    working_directory: /go/src/github.com/qlik-oss/qliksense-operator
    steps:
      - checkout
      - run: make test-unit
  build_release:
    docker:
      - image: circleci/golang:stretch
    working_directory: /go/src/github.com/qlik-oss/qliksense-operator
    steps:
      - checkout
      - run: make xbuild-all
      - run:
          name: "Publish Release on GitHub"
          command: |
            go get github.com/tcnksm/ghr
            # VERSION=v$(./artifacts/qliksense-linux-amd64 version | sed -nre 's/^[^0-9]*(([0-9]+\.)*[0-9]+).*/\1/p')
            ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete ${CIRCLE_TAG} /go/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/bin/qliksense-operator/
workflows:
    build_and_test:
      jobs:
        - unit-test
    build_and_publish_docker_image:
      jobs:
        - build_release:
            filters:
              branches:
                only: master
        - docker-publish/publish:
            image: qlik/qliksense-operator
            tag: latest
            filters:
              branches:
                only: master
